<template><h1 id="explication-structure-¬´-android-boilerplate-¬ª" tabindex="-1"><a class="header-anchor" href="#explication-structure-¬´-android-boilerplate-¬ª" aria-hidden="true">#</a> Explication structure ¬´ Android Boilerplate ¬ª</h1>
<p>Ce document n'est pas un TP, mais une explication de la structure ¬´ Android Boilerplate ¬ª disponible √† l'adresse suivante :</p>
<ul>
<li><a href="https://github.com/c4software/Android-Boilerplate-Koin-CoRoutines-OkHTTP" target="_blank" rel="noopener noreferrer">Android Boilerplate Koin - Rx - OkHttp<ExternalLinkIcon/></a></li>
</ul>
<p>Ce document vous donnera les cl√©s afin de comprendre le fonctionnement et de vous l'approprier.</p>
<div class="custom-container danger"><p class="custom-container-title">XML ou Compose ?</p>
<p>Nous sommes en 2021, le monde d'Android √©volue‚Ä¶ Pendant des ann√©es l'√©criture des ¬´ layouts ¬ª (interface) n'√©tait possible que via du XML. Il est maintenant possible d'√©crire les layouts de mani√®res bien plus modernes avec <a href="https://developer.android.com/jetpack/compose" target="_blank" rel="noopener noreferrer">JetPack Compose<ExternalLinkIcon/></a>. Le TP que vous suivez est toujours valide, mais repose sur l'utilisation de XML.</p>
</div>
<h2 id="but-du-code" tabindex="-1"><a class="header-anchor" href="#but-du-code" aria-hidden="true">#</a> But du code</h2>
<p>Le but du code fourni sur Github est de simplifier la mise en place d'une base applicative Android ¬´ moderne ¬ª. Il ne contient aucun code (presque). Il est donc clonnable / t√©l√©chargeable et utilisable tel quel, l'id√©e √©tant vraiment d'avoir presque un template d'application r√©utilisable √† volont√©.</p>
<p>Ceci √©tant annonc√©, passons au d√©tail du fonctionnement.</p>
<h2 id="recuperer-le-code" tabindex="-1"><a class="header-anchor" href="#recuperer-le-code" aria-hidden="true">#</a> R√©cup√©rer le code</h2>
<p>Pour r√©cup√©rer le code source, vous avez deux possibilit√©s :</p>
<ul>
<li>Le fichier zip en provenance de Github : <a href="https://github.com/c4software/Android-Boilerplate-Koin-CoRoutines-OkHTTP/archive/master.zip" target="_blank" rel="noopener noreferrer">√Ä t√©l√©charger ici<ExternalLinkIcon/></a></li>
<li>En clonant le repository : <code>git clone git@github.com:c4software/Android-Boilerplate-Koin-CoRoutines-OkHTTP.git</code></li>
</ul>
<p>‚ö†Ô∏è Attention, si vous avez choisi de cloner le repository. Pensez bien √† supprimer le dossier <code>.git</code> √† la racine des sources afin de ne pas garder l'historique de mon projet. ‚ö†Ô∏è</p>
<h2 id="lancer-le-projet-une-premiere-fois" tabindex="-1"><a class="header-anchor" href="#lancer-le-projet-une-premiere-fois" aria-hidden="true">#</a> Lancer le projet une premi√®re fois</h2>
<p>Avant d'effectuer des modifications dans le projet, nous allons le lancer une premi√®re fois. Pour √ßa, il suffit d'ouvrir le projet avec Android Studio.</p>
<p><img src="@source/tp/android/ressources/open_project.png" alt="Ouvrir le projet"></p>
<p>Une fois l'indexation termin√©e, vous devez pouvoir lancer le projet sur un √©mulateur ou sur votre t√©l√©phone. Ce qui devrait donner quelque chose comme :</p>
<p><img src="https://github.com/c4software/Android-Boilerplate-Koin-CoRoutines-OkHTTP/blob/master/capture.png?raw=true" alt="Demo"></p>
<h2 id="la-structure-des-dossiers" tabindex="-1"><a class="header-anchor" href="#la-structure-des-dossiers" aria-hidden="true">#</a> La structure des dossiers</h2>
<p>Afin de simplifier l'entr√©e dans le code, j'ai volontairement limit√© l'organisation des dossiers au strict minimum. Attention, √ßa ne veut pas dire que vous ne pouvez pas en cr√©er d'autres pour organiser votre code au mieux.</p>
<p><img src="@source/tp/android/ressources/structures.png" alt="structure dossier"></p>
<ul>
<li><code>data</code> : Contiens la d√©finition (interface) de vos sources de donn√©es (exemple la d√©finition des appels r√©seau).</li>
<li><code>di</code> : La d√©finition des √©l√©ments qui sont ¬´ inject√©s ¬ª.</li>
<li><code>domain</code> : Votre code m√©tier, celui qui fait le traitement (soit local, ou alors les appels aux APIs HTTP par exemple)</li>
<li><code>utils</code> : L'ensemble de vos ¬´ helpers ¬ª / fonctions que vous vous servez √† plusieurs endroits dans votre code.</li>
<li><code>view</code> : Vos ¬´ vues ¬ª, c'est-√†-dire vos diff√©rents √©crans de votre application.</li>
</ul>
<h2 id="mvvm-kezako" tabindex="-1"><a class="header-anchor" href="#mvvm-kezako" aria-hidden="true">#</a> MVVM ? K√©zako !?</h2>
<p>L‚Äôacronyme MVVM signifie Mod√®le Vue Vue-Mod√®le (Model‚Äìview‚Äìviewmodel). L'architecture MVVM est ¬´ plut√¥t r√©cente ¬ª elle date de 2004, elle est invent√©e √† la base par Microsoft afin de simplifier les probl√©matiques de gestion de l'interface (en utilisant des m√©caniques d'√©v√®nement)</p>
<p>Elle a r√©cemment √©t√© popularis√©e par certains frameworks JavaScript, car elle permet d'impl√©menter ¬´ simplement ¬ª des interfaces avec une r√©activit√© importante.</p>
<p><img src="@source/tp/android/ressources/MVVMPattern.png" alt="MVVM Pattern"></p>
<p>Cette m√©thode permet, tel le mod√®le MVC (mod√®le-vue-contr√¥leur), de s√©parer la vue de la logique et de l'acc√®s aux donn√©es en accentuant les principes de liaison et d‚Äô√©v√®nement.</p>
<p>Il faut donc distinguer <em>3 parties</em> :</p>
<ul>
<li>Le mod√®le : Les donn√©es au sens pures (de la data sous forme d'objet), elles peuvent provenir d'API, de base de donn√©es, de sources locales.</li>
<li>La vue : L'affichage utilis√© utilisateur, la gestion des clicks‚Ä¶ Et <em>uniquement</em> √ßa, la logique associ√©e √† la donn√©e est effectu√©e dans le <code>Vue-Mod√®le</code> (via ¬´ le bus des √©v√®nements ¬ª)</li>
<li>Le Vue-Mod√®le : Int√©ragie avec la couche <code>mod√®le</code> et envoi les nouveaux √©tats r√©sultat √† la vue (via le ¬´ bus des √©v√®nements ¬ª).</li>
</ul>
<p>Nous allons, donc devoir d√©finir ¬´ des ¬ª bus de communication entre le Vue-Mod√®le et la Vue afin de permettre l'actualisation des donn√©es. Cette organisation vous nous permettre une fois en place de ne manipuler essentiellement plus que de la donn√©e. La vue sera donc ¬´ automatiquement ¬ª mise √† jour, et ce en fonction de l'√©tat de la donn√©e (exemple les loaders / les mises √† jour de liste, etc.)</p>
<p>üìñPour ceux ayant d√©j√† fait du VueJS (ou autre framework JavaScript r√©cent), le d√©coupage est tr√®s proche, vous ne serez pas perdu.</p>
<h2 id="di-injection-de-dependances-koin-quelques-explications" tabindex="-1"><a class="header-anchor" href="#di-injection-de-dependances-koin-quelques-explications" aria-hidden="true">#</a> DI ? Injection de d√©pendances, Koin quelques explications</h2>
<p>En introduction j'ai indiqu√© que mon ¬´ Boilerplate ¬ª √©tait le strict minimum viable pour un projet‚Ä¶ Et bien je vous ai menti ! Mais garder confiance c'est pour votre bien‚Ä¶</p>
<p>Alors, l'injection des d√©pendances petite d√©finition Wikipedia :</p>
<blockquote>
<p>Il consiste √† cr√©er dynamiquement (injecter) les d√©pendances entre les diff√©rents objets en s'appuyant sur une description (fichier de configuration ou m√©tadonn√©es) ou de mani√®re programmatique. Ainsi les d√©pendances entre composants logiciels ne sont plus exprim√©es dans le code de mani√®re statique, mais d√©termin√©es dynamiquement √† l'ex√©cution.</p>
</blockquote>
<p>Pour faire simple, le but est de ne plus avoir √† cr√©er des objets dans votre code. Tout est g√©r√© ¬´ plus haut ¬ª afin de centraliser la configuration, la mani√®re dont l'objet est cr√©√©, etc.</p>
<p>Quelques avantages √† utiliser de l'injection :</p>
<ul>
<li>R√©duction du code (les cr√©ations d'objets sont effectu√©es qu'une seule fois et inject√©es automatiquement gr√¢ce au typage).</li>
<li>R√©duction de la m√©moire, logique moins d'instance d'objet identique cr√©er √† plusieurs endroits dans votre code.</li>
<li>Isolation entre la logique de l'objet et votre code, vous n'√™tes qu'un consommateur de fonctionnalit√©s la logique peut-√™tre carr√©ment √©crite par quelqu'un d'autre, voir dans certains cas externalis√©s dans des librairies externes (Kotlin Native par exemple).</li>
<li>Etc.</li>
</ul>
<h3 id="koin" tabindex="-1"><a class="header-anchor" href="#koin" aria-hidden="true">#</a> Koin</h3>
<p>Dans notre nous allons utiliser la librairie Koin, elle est compl√®tement √©crite en Kotlin, elle a comme avantage d'√™tre simple √† utiliser avec tr√®s peut de code √† √©crire (et donc √† comprendre).</p>
<h3 id="concretement-ca-ressemble-a-quoi" tabindex="-1"><a class="header-anchor" href="#concretement-ca-ressemble-a-quoi" aria-hidden="true">#</a> Concr√®tement √ßa ressemble √† quoi</h3>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code><span class="token keyword">val</span> appModule <span class="token operator">=</span> module <span class="token punctuation">{</span>
    <span class="token comment">// Inject dependencies for the MainViewModel (the only UI in this boilerplate)</span>
    viewModel <span class="token punctuation">{</span> <span class="token function">MainViewModel</span><span class="token punctuation">(</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">// Sample Remote Data Repository</span>
    single<span class="token operator">&lt;</span>SampleRemoteRepository<span class="token operator">></span><span class="token punctuation">(</span>createdAtStart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SampleRemoteRemoteRepositoryImpl</span><span class="token punctuation">(</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">// Sample Local Data Repository</span>
    single<span class="token operator">&lt;</span>SampleLocalRepository<span class="token operator">></span><span class="token punctuation">(</span>createdAtStart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">SampleLocalRepositoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">val</span> remoteDataSourceModule <span class="token operator">=</span> module <span class="token punctuation">{</span>
    <span class="token comment">// provided web components</span>
    single <span class="token punctuation">{</span> <span class="token function">createOkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">// Fill property</span>
    single <span class="token punctuation">{</span> createWebService<span class="token operator">&lt;</span>SampleRemoteDataSource<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BuildConfig<span class="token punctuation">.</span>REMOTE_URI<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">val</span> moduleApp <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>appModule<span class="token punctuation">,</span> remoteDataSourceModule<span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>L'ensemble est, je pense, relativement parlant, mais regardons en d√©tail le <code>get()</code>, comme vous pouvez le voir celui-ci est pr√©sent un peu partout dans la d√©claration de nos √©l√©ments √† injecter. Ce mot-cl√© est <em>magique</em> il permet √† <a href="https://insert-koin.io/" target="_blank" rel="noopener noreferrer">Koin<ExternalLinkIcon/></a> de d√©tecter le type de param√®tre attendu et d'injecter automatiquement le bon objet.</p>
<p>Par exemple nous indiquons que <code>createWebService(client: OkHttpClient, url: String)</code>, automatiquement Koin va chercher dans les objets qu'il connait ceux correspondant √† la signature (dans notre cas <code>single { createOkHttpClient() }</code>) et <code>BuildConfig.REMOTE_URI</code> √©tant la String attendu.</p>
<p>Dans le cas d'un objet de notre vue, nous avons dans le m√™me principe :</p>
<p><code>viewModel { MainViewModel(get(), get()) }</code> qui repr√©sente le View-Modele de notre Activity.</p>
<p>Celui-ci attend deux param√®tres :</p>
<p><code>MainViewModel(sampleRemoteRepository: SampleRemoteRepository, sampleLocalRepository: SampleLocalRepository)</code>.</p>
<p>Compliqu√© ? Pas tellement, avec la pratique √ßa vous semblera automatique. üòä</p>
<h2 id="modifier-le-package-¬´-sample-¬ª" tabindex="-1"><a class="header-anchor" href="#modifier-le-package-¬´-sample-¬ª" aria-hidden="true">#</a> Modifier le package ¬´ sample ¬ª</h2>
<p>Comme vous le savez, sur Android les applications doivent √™tre uniques ¬´ de mani√®re cryptographique ¬ª une partie du test est bas√© sur leur package. Nous allons donc faire en sorte de personnaliser le package afin de le rendre unique pour vous et votre t√©l√©phone.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/3tULbe0wPmU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<h2 id="changer-le-nom-de-l-application" tabindex="-1"><a class="header-anchor" href="#changer-le-nom-de-l-application" aria-hidden="true">#</a> Changer le nom de l'application</h2>
<p>Si vous regardez dans votre liste d'application vous allez trouver une application nomm√©e <code>Boilerplate - Koin - Retrofit</code>. Pour le changer, c'est simple, il suffit d'√©diter le fichier <code>strings.xml</code>.</p>
<p>‚ö†Ô∏è En parlant de ce fichier, celui-ci <em>doit</em> contenir l'ensemble de vos textes (et √©videmment pas uniquement le nom de votre application).</p>
<h2 id="changer-la-configuration-de-l-api" tabindex="-1"><a class="header-anchor" href="#changer-la-configuration-de-l-api" aria-hidden="true">#</a> Changer la configuration de l'API</h2>
<p>Centraliser la configuration dans une application est <em>essentiel</em> au-del√† de l'organisation du code, c'est essentiel pour que vous puissiez travailler en √©quipe, mais √©galement pour reprendre votre code sereinement dans quelques ann√©es (eh oui‚Ä¶). Dans notre application la configuration sera centralis√©e dans le fichier <code>build.gradle</code>.</p>
<p>Si vous regardez le fichier en question, vous allez trouver <code>buildConfigField</code> cette instruction nous permettra de d√©finir de la configuration propre √† l'environnement (Prod, Dev, Staging, etc.). Bref c'est g√©nial !</p>
<p>J'ai donc initialis√© dans mon petit Boilerplate <code>REMOTE_URI</code> qui sera dans votre code Kotlin l'URL de votre serveur distant.</p>
<h2 id="repository-kezako" tabindex="-1"><a class="header-anchor" href="#repository-kezako" aria-hidden="true">#</a> Repository ? K√©zako !?</h2>
<p>Contiens la logique autour de vos donn√©es. Elle expose au reste de l'application une API (Interne) permettant de g√©rer la mise √† jour des donn√©es.</p>
<p>Cette ¬´ brique de code ¬ª va permettre d'agr√©ger les diff√©rentes sources de donn√©es afin d'√™tre utilisable simplement dans vos VueModel (ViewModel).</p>
<p>üõë N'h√©sitez pas √† d√©couper autant qu'il le faut votre logique dans diff√©rents repository üôè</p>
<h3 id="localrepository" tabindex="-1"><a class="header-anchor" href="#localrepository" aria-hidden="true">#</a> LocalRepository ?</h3>
<p>Dans le code fourni en exemple, le <code>Local Repository</code> ¬´ simule ¬ª un repository qui acc√®derait √† des donn√©es ¬´ local ¬ª c'est-√†-dire dans votre t√©l√©phone (m√©moire interne par exemple).</p>
<h3 id="remoterepository" tabindex="-1"><a class="header-anchor" href="#remoterepository" aria-hidden="true">#</a> RemoteRepository ?</h3>
<p>Dans le code fourni en exemple, le <code>Remote Repository</code> ¬´ simule ¬ª une interaction avec ¬´ l'ext√©rieur ¬ª de votre t√©l√©phone c'est-√†-dire dans notre cas <code>Internet</code> via un appel d'API via le protocole HTTP.</p>
<h2 id="ajouter-une-nouvelle-route-d-api-distance" tabindex="-1"><a class="header-anchor" href="#ajouter-une-nouvelle-route-d-api-distance" aria-hidden="true">#</a> Ajouter une nouvelle route d'API distance</h2>
<p>Ajouter une nouvelle route d'API √† notre projet va se r√©sumer √† la modification de quelques fichiers. √Ä premier vu √ßa peut sembler fastidieux, mais vous allez rapidement voir que ce d√©coupage va nous permettre d'organiser le code au mieux afin de le rendre maintenant dans la dur√©e. Et finalement n'est-ce pas le plus important ?</p>
<p>Je vais prendre un exemple simple, le souhaite ajouter une nouvelle route disponible sur <code>https://rest.ensembl.org/</code> dans mon projet. Au hasard la route <code>/info/rest?content-type=application/json</code>.</p>
<p>ü§îJe rappelle au passage que la finalit√© est de ¬´ R√©cup√©rer l'information ¬ª du serveur, le faire transiter dans votre code, pour au final l'afficher quelque part dans votre application.</p>
<h3 id="declarer-l-appel-http-dans-sampleremotedatasource" tabindex="-1"><a class="header-anchor" href="#declarer-l-appel-http-dans-sampleremotedatasource" aria-hidden="true">#</a> D√©clarer l'appel HTTP dans SampleRemoteDataSource</h3>
<p>D√©clarer une m√©thode dans le fichier <code>sampleRemoteDataSource.kt</code>, ce fichier est une Interface, qui va ¬´ d√©clarer ¬ª l'ensemble des m√©thodes HTTP appelable dans le code. La d√©claration de celles-ci est effectu√©e via des annotations (symbolis√© avec <code>@</code>). Dans notre cas le fichier contient actuellement :</p>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code><span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">"info/ping?content-type=application/json"</span><span class="token punctuation">)</span>
<span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">"Content-type: application/json"</span><span class="token punctuation">)</span>
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> PingResult
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Nous d√©clarons donc une m√©thode de type <code>GET</code> qui consommera un retour en JSON.</p>
<p>Nous allons ajouter la seconde m√©thode de la m√™me fa√ßon</p>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code><span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">"info/rest?content-type=application/json"</span><span class="token punctuation">)</span>
<span class="token annotation builtin">@Headers</span><span class="token punctuation">(</span><span class="token string">"Content-type: application/json"</span><span class="token punctuation">)</span>
<span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">restInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RestResult
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Vous allez devoir cr√©er une Data Class <code>RestResult</code> qui servira √† d√©serialser le retour de l'API. Elle va ressembler √† :</p>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code><span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">RestResult</span><span class="token punctuation">(</span><span class="token keyword">val</span> release<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>üëÄAttention üëÄ ranger le fichier dans le bon dossier/package ! √Ä savoir <code>data/models/RestResult</code>.</p>
<h4 id="comment-ca-fonctionne-en-deux-mots" tabindex="-1"><a class="header-anchor" href="#comment-ca-fonctionne-en-deux-mots" aria-hidden="true">#</a> Comment √ßa fonctionne en deux mots ?</h4>
<p>D√©clarer une m√©thode dans une Interface pour permettre d'appeler un WebService !? C'est magique ? En r√©alit√© tout √ßa est possible grace √† OkHTTP2, Retrofit, et l'injection de d√©pendance. Pour les curieux, toute la logique est ici <code>src/main/java/com/boilerplate/app/di/remote_datasource_model.kt</code></p>
<h3 id="declarer-la-methode-dans-sampleremoterepository" tabindex="-1"><a class="header-anchor" href="#declarer-la-methode-dans-sampleremoterepository" aria-hidden="true">#</a> D√©clarer la m√©thode dans SampleRemoteRepository</h3>
<p>La premi√®re √©tape √©tait la d√©claration dans l'interface, c'est chose faite. Maintenant nous allons d√©clarer notre m√©thode dans le <code>Repository</code>, donc dans la brique qui va appeler la source de donn√©es.</p>
<p>Nous allons donc tout simplement :</p>
<ul>
<li>Ajouter la d√©claration de la m√©thode dans l'interface <code>SampleRemoteRepository</code> nomm√©e infoRest.</li>
<li>Impl√©menter la m√©thode <code>infoRest</code> dans <code>SampleRemoteRemoteRepositoryImpl</code> afin de pouvoir appeler l'API.</li>
</ul>
<h3 id="l-appeler-depuis-le-code" tabindex="-1"><a class="header-anchor" href="#l-appeler-depuis-le-code" aria-hidden="true">#</a> L'appeler depuis le code</h3>
<p>Pour tester (et uniquement pour tester), nous allons appeler la nouvelle m√©thode depuis la vue principale. La proc√©dure va √™tre relativement simple :</p>
<ul>
<li>Ajout d'une m√©thode dans <code>MainViewModel.kt</code>
<ul>
<li>La m√©thode doit impl√©menter les states. (Chargement, et retour de la ¬´ string re√ßu ¬ª)</li>
</ul>
</li>
<li>Appeler la m√©thode d√©clar√©e dans le MainViewModel depuis l'activity. (ex <code>myViewModel.getRestInfomations()</code>).</li>
</ul>
<p>Dans l'impl√©mentation actuelle, je vous propose d'afficher un <code>un Toast</code> lors de la r√©ception de la donn√©e.</p>
<h2 id="ajouter-une-nouvelle-activity" tabindex="-1"><a class="header-anchor" href="#ajouter-une-nouvelle-activity" aria-hidden="true">#</a> Ajouter une nouvelle Activity</h2>
<p>Maintenant que nous avons valid√© que notre code fonctionne, nous allons pouvoir ajouter une nouvelle vue. Nous avons une nouvelle route <code>infoRest</code> qui pour l'instant est inutilis√©e, nous allons cr√©er une vue et le code associ√© afin d'afficher l'information re√ßue du serveur.</p>
<h3 id="layout" tabindex="-1"><a class="header-anchor" href="#layout" aria-hidden="true">#</a> Layout</h3>
<p>La premi√®re √©tape va √™tre la cr√©ation de la vue. Pour √ßa cr√©er un Layout XML comme nous avons d√©j√† pu le voir ensemble.</p>
<h3 id="code" tabindex="-1"><a class="header-anchor" href="#code" aria-hidden="true">#</a> Code</h3>
<p>Le minimum de code pour que votre activity fonctionne est le suivant :</p>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code><span class="token keyword">class</span> YourActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">fun</span> <span class="token function">getStartIntent</span><span class="token punctuation">(</span>ctx<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token operator">:</span> Intent <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">Intent</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> YourActivity<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_demo<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>üëÄ Comme toujours l'organisation du code est une chose tr√®s importante, ne placez pas votre classe n'importe o√π. Mais dans un package dans <code>view</code> :</p>
<p><img src="@source/tp/android/ressources/create_package.png" alt="create package"></p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/M1RJ1kQg7Hg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>Si vous souhaitez plus de d√©tail, inspirer du code pr√©sent dans le <code>MainActivity.kt</code> ou dans les exemples que nous avons √©voqu√©s pendant le cours.</p>
<h4 id="getstartintent" tabindex="-1"><a class="header-anchor" href="#getstartintent" aria-hidden="true">#</a> getStartIntent ?</h4>
<p>Cette m√©thode a pour but de simplifier la lecture (et la navigation) entre les vues. Cette m√©thode est statique, elle sera appel√©e que vous souhaiterez appeler votre <code>activity</code> depuis une autre <code>vue</code> / <code>activity</code>. Elle retourne une <code>Intent</code> qui nous servira √† d√©marrer l'activity souhait√©e.</p>
<p><em>Exemple :</em></p>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code>    <span class="token function">startActivity</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span><span class="token function">getStartIntent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Le but √©galement de cr√©er des <code>getStartIntent</code> est de simplifier la gestion du passage des param√®tres. En effet, sur Android passer des param√®tres √† une activit√© se r√©sume √† les attacher √† l'Intent. Centraliser la d√©claration, permet √©galement de centraliser cette logique.</p>
<p><em>Exemple :</em></p>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code><span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> AGE_DU_CAPITPAINE <span class="token operator">=</span> <span class="token string">"AGE_DU_CAPITPAINE"</span>
    <span class="token keyword">fun</span> <span class="token function">getStartIntent</span><span class="token punctuation">(</span>ctx<span class="token operator">:</span> Context<span class="token punctuation">,</span> ageDuCapitaine<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Intent <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Intent</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> MainActivity<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span>
            <span class="token function">putExtra</span><span class="token punctuation">(</span>FROM_HOME<span class="token punctuation">,</span> ageDuCapitaine<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Pour r√©cup√©rer cette valeur.</span>
<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">ageDuCapitaine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getBooleanExtra</span><span class="token punctuation">(</span>AGE_DU_CAPITPAINE<span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="rendre-accessible-cette-vue-activity" tabindex="-1"><a class="header-anchor" href="#rendre-accessible-cette-vue-activity" aria-hidden="true">#</a> Rendre accessible cette vue / activity</h2>
<p>Maintenant que cette activity est cr√©√©e, nous allons devoir la rendre ¬´ visible ¬ª par Android. Cette √©tape est relativement simple. Il suffit de laisser faire votre IDE pour lui faire autod√©clarer le bon XML dans le fichier <code>AndroidManifest.xml</code>.</p>
<p>Si vous souhaitez r√©aliser cette action √† la main. Il suffit d'ajouter ¬´ dans / sous ¬ª l'√©l√©ment application :</p>
<div class="language-xml ext-xml line-numbers-mode"><pre v-pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.boilerplate.app.view.main.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>‚ö†Ô∏è Mais s√©rieusement, ne l'ajoutez pas √† la main. Faite plut√¥t alt entr√©e sur le nom de votre class dans l'IDE l'action vous sera propos√©e.</p>
<p><img src="@source/tp/android/ressources/add_manifest.png" alt="ajouter au manifeste"></p>
<h3 id="creer-une-home" tabindex="-1"><a class="header-anchor" href="#creer-une-home" aria-hidden="true">#</a> Cr√©er une home</h3>
<p>En suivant le m√™me principe que pr√©c√©demment, cr√©ez une Home avec deux boutons permettant d'acc√©der √† la <code>MainActivity</code> et √† <code>InfoRestActivity</code>.</p>
<p>Petit rappel, pour ¬´ attacher ¬ª une action de clique sur un bouton :</p>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code>btnMain<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>
    <span class="token function">startActivity</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span><span class="token function">getStartIntent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

btnInfosRest<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>
    <span class="token function">startActivity</span><span class="token punctuation">(</span>InfoRestActivity<span class="token punctuation">.</span><span class="token function">getStartIntent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="declarer-cette-home-comme-activity-principale-de-votre-application" tabindex="-1"><a class="header-anchor" href="#declarer-cette-home-comme-activity-principale-de-votre-application" aria-hidden="true">#</a> D√©clarer cette home comme activity principale de votre application</h3>
<p>Un certain nombre de param√®tres autour des intent est modifiable directement dans <code>AndroidManifest.xml</code>, la d√©claration de <code>l'intent</code> √† lancer au d√©marrage de l'application est faite via :</p>
<div class="language-xml ext-xml line-numbers-mode"><pre v-pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.intent.action.MAIN<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.intent.category.LAUNCHER<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>D√©placer <code>l'intent filter</code> dans bloc correspondant √† votre activity.</p>
<h3 id="connecter-le-tout" tabindex="-1"><a class="header-anchor" href="#connecter-le-tout" aria-hidden="true">#</a> Connecter le tout</h3>
<p>Votre application contient maintenant 3 activit√©s :</p>
<ul>
<li>Une home.</li>
<li>L'activit√© permettant de connaitre la version du serveur. <code>infoRest</code></li>
<li>Une activit√© permettant de ¬´ r√©aliser des pings ¬ª.</li>
</ul>
<p>Appeler les diff√©rends <code>getStartIntent()</code> depuis les bonnes vues.</p>
<p>Exemple :</p>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code><span class="token keyword">fun</span> <span class="token function">startMainActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">startActivity</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span><span class="token function">getStartIntent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="utiliser-un-repository-depuis-une-nouvelle-activity" tabindex="-1"><a class="header-anchor" href="#utiliser-un-repository-depuis-une-nouvelle-activity" aria-hidden="true">#</a> Utiliser un Repository depuis une nouvelle activity</h2>
<p>Comme indiqu√© pr√©c√©demment, nous n'allons pas directement appeler notre <code>Repository</code> directement depuis notre <code>Activity</code>.</p>
<div class="custom-container tip"><p class="custom-container-title">Petit rappel</p>
<p>Nous allons d√©couper notre logique en diff√©rentes parties :</p>
<ul>
<li>La logique de la vue va rester dans l'Activity.</li>
<li>La logique des donn√©es de la vue va √™tre mise dans la partie <code>ViewModel</code>.</li>
<li>La logique ¬´ de r√©cup√©ration ¬ª des donn√©es va √™tre mise dans un <code>Repository</code>.</li>
</ul>
</div>
<p>Cr√©er un ViewModel pour une <code>Activity</code> va se r√©sumer √† trois op√©rations :</p>
<ul>
<li>Cr√©er une Class <code>YourActivityViewModel</code> et qui extend de <code>BaseViewModel()</code></li>
<li>D√©clarer votre <code>YourActivityViewModel</code> dans l'activity en sp√©cifiant que celui-ci sera automatiquement inject√©.</li>
<li>Le d√©clarer dans l'injecteur de d√©pendances.</li>
</ul>
<h3 id="creation-de-votre-youractivityviewmodel" tabindex="-1"><a class="header-anchor" href="#creation-de-votre-youractivityviewmodel" aria-hidden="true">#</a> Cr√©ation de votre <code>YourActivityViewModel</code></h3>
<p>Cette √©tape est la premi√®re, nous allons cr√©er une Class qui contiendra la ¬´ logique ¬ª des donn√©es de la vue, le minimum que doit contenir cette classe est :</p>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code>
<span class="token keyword">class</span> <span class="token function">YourActivityViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">BaseViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> states <span class="token operator">=</span> MutableLiveData<span class="token operator">&lt;</span>ViewModelState<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Vous d√©clarerez ici vos m√©thodes et variables n√©cessaires</span>
    <span class="token comment">// au bon fonctionnement de votre application.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">Vous voulez un exemple ¬´ plus grand ¬ª ?</p>
<p>Vous avez dans le projet un exemple de <code>ViewModel</code> un peu plus complet, c'est le fichier <code>MainViewModel.kt</code> il est √©galement <a href="https://raw.githubusercontent.com/c4software/Android-Boilerplate-Koin-CoRoutines-OkHTTP/master/app/src/main/java/com/boilerplate/app/view/main/MainViewModel.kt" target="_blank" rel="noopener noreferrer">accessible ici<ExternalLinkIcon/></a></p>
</div>
<h3 id="declarer-votre-viewmodel-dans-l-activity" tabindex="-1"><a class="header-anchor" href="#declarer-votre-viewmodel-dans-l-activity" aria-hidden="true">#</a> D√©clarer votre ViewModel dans l'activity</h3>
<p>Pour √ßa rien de bien compliqu√©, il suffit d'ajouter le code suivant :</p>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code>    <span class="token keyword">private</span> <span class="token keyword">val</span> myViewModel<span class="token operator">:</span> YourActivityViewModel <span class="token keyword">by</span> <span class="token function">viewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><div class="custom-container danger"><p class="custom-container-title">Attention</p>
<p>Ne pas mettre le code n'importe o√π. Nous avons ici un <strong>attribut de class</strong>.</p>
</div>
<h3 id="declaration-dans-l-injecteur-de-dependance" tabindex="-1"><a class="header-anchor" href="#declaration-dans-l-injecteur-de-dependance" aria-hidden="true">#</a> D√©claration dans l'injecteur de d√©pendance</h3>
<p>Si vous souhaitez que √ßa fonctionne, vous devez dire √† votre code comment le <code>by viewModel()</code> va √™tre r√©solu. Pour √ßa nous devons indiquer √† notre injecteur de d√©pendance comment cr√©er cette d√©pendance, cette d√©claration est √† faire dans le fichier <code>app_module.kt</code> (il se trouve dans le package <code>.di</code>).</p>
<p>Vous devez donc ajouter dans le <code>appModule</code> le code suivant :</p>
<div class="language-kotlin ext-kt line-numbers-mode"><pre v-pre class="language-kotlin"><code>    viewModel <span class="token punctuation">{</span> <span class="token function">YourActivityViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>ü§ì Bien √©videmment, vous ajoutez le code √† la suite du <code>viewModel</code> d√©j√† pr√©sent ü§ì</p>
</template>
