---
description: Nous avons vu pr√©c√©demment qu'il √©tait simple de cr√©er des sites Web avec Laravel. Dans le monde du d√©veloppement, il est tr√®s courant de ne pas √©changer entre le client et le serveur directement en HTML, mais directement en JSON.
---

# API & Client Web Simple

::: tip Vous pouvez consulter une nouvelle version
üö® Une nouvelle version de ce TP est disponible [ici](./api_produit.md).
:::

Nous avons vu pr√©c√©demment qu'il √©tait simple de cr√©er des sites Web avec Laravel. Dans le monde du d√©veloppement, il est tr√®s courant de ne pas √©changer entre le client et le serveur directement en HTML, mais directement en JSON.

Nous appelons cette fa√ßon des API (dans notre cas des API REST), c'est le fondement m√™me de beaucoup de sites Internet que vous utilisez tous les jours (Gmail, Facebook, ‚Ä¶).

Laravel √©tant un framework ¬´ √† tout faire ¬ª celui-ci nous permet bien √©videmment de cr√©er √©galement des API. C'est ce que nous allons faire dans ce TP.

::: tip API ?
Ce que vous venez de cr√©er est une API. Une API est le coeur de beaucoup de syst√®mes moderne. Il est important de comprendre ce concept d√®s √† pr√©sent. Pourquoi faire une API ?

Une API va nous permettre de s√©parer la logique entre client et serveur afin de r√©aliser si vous le souhaitez diff√©rent client pour la m√™me donn√©e (exemple Twitter avec des clients multiplateformes).

Pourquoi pr√©f√©rer une API ¬´ JSON / XML ¬ª √† un retour HTML basic ? Tout simplement, car l'API va √™tre universelle; nous pourrons donc l'utiliser dans un site Internet, mais √©galement dans une application ou n'importe quel client applicatif (web, Android, iOs, une voiture, une TV‚Ä¶).
:::

::: details Sommaire
[[toc]]
:::

## Cr√©er votre projet

Pour cette √©tape, je vous laisse suivre le d√©but du [pr√©c√©dent TP](./introduction.md).

**Attention** a bien installer au moins la version >11 de Laravel.

## Activer les API

Depuis Laravel 11 la structure des fichiers/dossiers √† chang√©. Les API ne sont maintenant plus activ√©e par d√©faut. Pour les activer il suffit de lancer la commande suivante :

```bash
php artisan install:api
```

Cette commande va modifier votre projet pour activer le routeur sp√©cifique aux API.

::: tip Note

Il est √©galement possible de mettre les API directement dans le fichier `web.php` mais pour des raisons de clart√© et de s√©paration des responsabilit√©s, il est pr√©f√©rable de les mettre dans un fichier d√©di√©.

:::

## Cr√©ation de la base de donn√©es

La premi√®re √©tape comme toujours est d'ajouter dans votre projet ¬´ une nouvelle migration ¬ª afin de cr√©er la base de donn√©es relative √† notre probl√©matique.

Dans notre cas, voil√† la table que nous souhaitons cr√©er :

![Table Concert](./ressources/concert_db.png)

Je vous laisse r√©aliser les √©tapes suivantes :

- Cr√©ation de la migration et le mod√®le `php artisan make:model Concert --migration`
- D√©finir les champs dans la migration, mais √©galement dans le `$fillable`.
- Lancer la migration `php artisan migrate`

::: tip Un doute sur comment faire ?
√áa fait plusieurs fois que nous faisons ce genre d'op√©ration. Si vous avez un doute, vous pouvez regarder le d√©tail [dans le TP](./introduction.md#la-base-de-donnees)
:::

::: danger STOP !
Nous avons donc maintenant une base de donn√©es de test. Avant d'aller plus loin‚Ä¶ Je vous laisse ins√©rer des donn√©es fictives pour que nous ayons un peu de contenu.

Vous avez deux fa√ßons de faire √ßa :

- Directement en base ¬´ manuellement ¬ª.
- [Via Une Factories + Un Seeder de Laravel](https://laravel.com/docs/8.x/seeding)

L'avantage du seeder ? Il va permettre de cr√©er beaucoup de donn√©es en un rien de temps ! 50 Concerts ? Aucun probl√®me il suffit de faire :

```php
Concert::factory()->count(50)->create();
```

Pour l'impl√©mentation nous allons le faire ensemble, mais √ßa se r√©sume √† :

```shell
php artisan make:factory ConcertFactory
```

Je vous laisse configurer la factory (`/database/factories/ConcertFactory.php`) en prenant exemple sur celle de la partie User. Mais dans les grandes ligne il faut ajouter

```php
public function definition(){
  return [
      'name' => $this->faker->name,
      'date' => $this->faker->date(),
  ];
}
```

√âditer maintenant le DatabaseSeeder pour ajouter dans le run() :

```php
Concert::factory()->count(50)->create();
```

```shell
php artisan db:seed
# Vous avez maintenant 50 concerts dans votre table
```

Pratique !

:::

## Cr√©ation de l'API

La cr√©ation d'une API va √™tre tr√®s proche de ce que nous connaissons d√©j√†. Premi√®re √©tape cr√©er un contr√¥leur ; pour rappel celui-ci permet de g√©rer le traffic et de r√©pondre aux demandes des / du clients.

Notre API sera tr√®s simple, elle contiendra **3 routes / fonctionnalit√©s** :

| M√©thode | Chemin              | Fonctionnalit√©                                                  |
| ------- | ------------------- | --------------------------------------------------------------- |
| GET     | `/api/concert`      | Liste de l'ensemble des concerts                                |
| POST    | `/api/concert`      | Ajout d'un nouveau concert (en fournissant les donn√©es en POST) |
| DELETE  | `/api/concert/{id}` | Suppression du concert sp√©cifi√© en param√®tre `id`               |

L'ensemble des routes va retourner du JSON. Comme vu ensemble en cours, le format JSON est tr√®s facilement lisible, quel que soit le langage client. C'est donc un tr√®s bon choix !

::: warning Avant de coder il faut d√©finir
Le petit tableau que je vous propose ici est tr√®s important. Il permet de savoir ce que je veux faire. Nous sommes ici dans un TP‚Ä¶ Mais vous codez comme si vous √©tiez dans un projet ¬´ classique ¬ª.

Il est donc important de d√©finir ce que l'on souhaite faire‚Ä¶ Pour soit, mais √©galement pour vos coll√®gues qu'ils sachent ce que vous √™tes entrain de faire.
:::

### Cr√©ation du contr√¥leur

Le contr√¥leur vous savez faire, nous allons faire un nouveau contr√¥leur, celui-ci sera d√©di√© √† la partie API :

```bash
php artisan make:controller ApiControler
```

Je ne vous d√©taille pas plus cette √©tape nous l'avons vu plusieurs fois pr√©c√©demment.

Bien ! Notre code est maintenant pr√™t. Nous allons cr√©er les m√©thodes permettant la manipulation de notre base de donn√©es tout en r√©pondant √† nos API bien √©videmment (liste, cr√©ation, terminer, suppression).

Nous allons maintenant √©crire une m√©thode pour chaque action. Avec les diff√©rentes conditions n√©cessaires au bon fonctionnement de votre application.

### Liste

La m√©thode `liste` est certainement la plus simple, nous allons simplement faire appel √† la m√©thode `all()` de Eloquent (ORM pour l‚Äôacc√®s √† la base de donn√©es). Pour √ßa cr√©ez une nouvelle m√©thode dans la Class `ApiController` avec le code suivant :

```php
public function listApi(){
    return response()->json(Concert::all());
}
```

Rien de bien compliqu√©, comme vous pouvez le voir le `response()->json(‚Ä¶)` permet de cr√©er une r√©ponse au format JSON pour votre API (que l‚Äôon utilisera plus tard au moment de la mise en place des routes).

::: tip Et oui !
C'est aussi simple que √ßa ! Avec cette simple m√©thode, vous avez √©crit votre premi√®re API.

<center><iframe src="https://giphy.com/embed/UtQHZEv5M7POO8t2WW" width="280" height="160" frameBorder="0" class="giphy-embed" allowFullScreen></iframe></center>
:::

::: danger Un instant ‚úã

En PHP objet il y a la notion de namespace, Laravel utilise de base les namespace, √ßa veut dire que nous allons avoir √† utiliser le mot cl√© `use` pour importer (include). Quand vous voulez utiliser une classe qui n'est pas dans le m√™me fichier, il faudra d√©clarer l'emplacement via un `use`. Exemple, pour que `Concert` soit accessible depuis le contr√¥leur il faudra :

```php
use App\Models\Concert;
```

- ‚ö†Ô∏è Si vous utilisez **PHPStorm** cet import sera automatique.
- ‚ö†Ô∏è Si vous utilisez **VSCode** il faudra passer par une extension [Disponible ici](https://marketplace.visualstudio.com/items?itemName=MehediDracula.php-namespace-resolver)

Pour **PHPStorm**, alt+entr√©e permettra de d√©clencher l'ajout du use.

Pour **VSCode** je vous laisse regarder l'usage de l'extension :

![Namespace Resolver](../../cheatsheets/laravel/res/namespace_resolver.gif)

:::

### La Cr√©ation

Pour l'ajout, c'est un peu diff√©rent, nous allons cr√©er dans la base de donn√©es un nouvel enregistrement √† chaque requ√™te de type `POST`. Nous allons donc devoir √©crire un peu de code.

Pour la partie cr√©ation, nous allons faire un mapping automatique entre la requ√™te HTTP et le mod√®le `Concert`

```php
public function createApi(Request $request){
    $item = Concert::create($request->all());
    return response()->json($item);
}
```

::: tip üò¨
Que va-t-il se passer lors de l‚Äôappel ? L‚Äôobjet `$request` contiens tous les param√®tres de l‚Äôappel HTTP, la m√©thode `all()` permets de les r√©cup√©rer. L‚Äôobjet `Concerts` poss√®de une m√©thode permettant de cr√©er un nouvel enregistrement en base de donn√©es. Les valeurs pass√©es en param√®tre de `createApi()` permettre de renseigner automatiquement les champs en base de donn√©es.
:::

### Cr√©ation, version alternative

La premi√®re approche est la plus rapide, mais elle sous-entend que tous les param√®tres soient bien initialis√©s dans ¬´ l‚Äôinput ¬ª HTTP. Dans cette version la m√©thode est plus compl√®te et g√®re la cr√©ation de l‚Äôobjet Concert manuellement en r√©cup√©rant les diff√©rents √©l√©ments dans la requ√™te HTTP

```php
public function createApi(Request $request){
    $name = $request->input('name');
    $date = $request->input('date');

    if($name){
      $concert = new Concert();
      $concert->name = $name;
      $concert->date = $date;
      $concert->save();
      return response()->json(["status" => "success"]);
    }else{
      return response()->json(["status" => "error"]);
    }
  }
```

### Suppression

Pour la partie suppression, nous allons devoir dans un premier temps r√©cup√©rer le Concert par son ID.

```php
public function deleteApi($id){
    $concert = Concert::find($id);
    if($concert){
        $concert->delete();
        return response()->json(["status" => "success"]);
    }else{
        return response()->json(["status" => "error"]);
    }
}
```

### D√©finir les routes

Votre code est maintenant pr√™t, il faut le ¬´ brancher ¬ª dans votre `Router` pour que celui-ci soit accessible aux utilisateurs. Cette fois-ci nous n'allons pas ajouter nos routes dans le fichier `web.php` car ce ne sont pas des liens ¬´ web ¬ª‚Ä¶ Mais dans attention‚Ä¶

‚Ä¶Roulement de tambour‚Ä¶
‚Ä¶
‚Ä¶Attention‚Ä¶
‚Ä¶

`api.php` Je vous donne le code √† ajouter, mais celui-ci est classique, c'est juste des liens tels que nous le faisons dans la partie `web.php` :

::: details Je pense que vous savez faire‚Ä¶ Mais si vous avez oubli√© ‚Ä¶

Je sais que vous avez cliqu√© sans vraiment chercher‚Ä¶

```php
Route::get('/concert', ['App\Http\Controllers\ApiControler', 'listApi']);
Route::post('/concert', ['App\Http\Controllers\ApiControler', 'createApi']);
Route::delete('/concert/{id}', ['App\Http\Controllers\ApiControler', 'deleteApi']);
```

:::

ü§ì Les routes que vous ajoutez dans le fichier `api.php` sont automatiquement pr√©fix√©es par `/api/`.

::: danger Et le type de la m√©thode ?
N'oubliez pas le type de la m√©thode ! Surtout pas ! Dans le tableau nous avons d√©fini des types de m√©thode (GET, POST, DELETE), c'est important de respecter nos sp√©cifications !
:::

### Tester votre API

Maintenant que l‚Äôensemble de votre code est termin√© (et comment√© üïµüèª), nous allons pouvoir le tester, pour tester les API c‚Äôest plut√¥t simple. Il suffit d‚Äôutiliser des outils tels que [Postman](https://www.getpostman.com/), l‚Äôid√©e c‚Äôest de se construire un ¬´ cahier ¬ª de test vous permettant de valider le fonctionnement de votre application rapidement (comprendre d√®s que vous modifiez le code). C‚Äôest dans ce but que je vous ai pr√©par√© une collection de ¬´ tests ¬ª qui devrait vous permettre de valider rapidement le bon fonctionnement de vos API.

Valider que vos API fonctionnent correctement gr√¢ce √† l'outil [Postman](https://www.getpostman.com/).

(Pssst! La cr√©ation de comptes **n'est pas obligatoire**) <-- ‚ö†Ô∏è‚ö†Ô∏è

ü§ì Commencez par la plus simple, par exemple `/api/` qui doit normalement liste actuelle de concert. ü§ì

‚úã Tester l'ensemble de vos API avant de continuer.

## Et les clients dans tout √ßa ?

Nous avons √©crit des API‚Ä¶ Mais pour l'instant nous n'avons pas de client (interface qui les utilise), c'est dommage ! Je suis sympa, je vais vous donner une astuce ! Sur Internet nous trouvons tout (oui oui). Vos clients peuvent √™tre :

- Une page Web.
- Une application Android.
- etc‚Ä¶

Nous allons tester que √ßa fonctionne correctement gr√¢ce √† une page Web, et √ßa va √™tre tr√®s simple‚Ä¶ tr√®s tr√®s simple. Nous allons faire de l'Ajax (ne partez pas, √ßa va bien se passer). Pour simplifier, nous allons utiliser une excellente [librairie nomm√©e Tabulator](http://tabulator.info/)

### Installer Tabulator

Tabulator est une librairie JavaScript qui va nous masquer toute la partie appel de l'API, mais √©galement toute la partie cr√©ation du tableau affichant les r√©sultats (avec plein d'options super cools). La premi√®re √©tape est donc d'ajouter la librairie dans votre projet.

Pour √ßa il suffit de suivre le : [Guide d'installation](http://tabulator.info/docs/4.9/install#sources-cdn)

En suivant le guide d'installation, nous voyons qu'il faut ajouter dans notre projet (dans le `head`) les liens suivants :

```html
<link
  href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css"
  rel="stylesheet"
/>
<script
  type="text/javascript"
  src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"
></script>
```

### Utiliser Tabulator

Nous allons charger de la donn√©e via un appel Ajax, avec Tabulator c'est tr√®s simple, c'est m√™me int√©gr√© [il suffit de suivre la documentation](http://tabulator.info/docs/4.9/data#ajax)

Si nous suivons la documentation, nous voyons qu'il suffit d'ajouter dans votre page fraichement cr√©√©e le code suivant :

```html
<div id="data"></div>
<script>
  let myTable = new Tabulator("#data", {
    height: "311px",
    layout: "fitColumns",
    ajaxURL: "/api/concert",
    placeholder: "Aucune donn√©es",
    columns: [
      { title: "Nom", field: "name", sorter: "string", width: 200 },
      { title: "Date du concert", field: "date", sorter: "date" },
    ],
  });

  // myTable.setData("/api/concert");
</script>
```

::: danger La documentation, La documentation
Je n'invente rien ! Tout ce que je vous donne ici ne sont que des utilisations telles que d√©fini dans la [documentation](http://tabulator.info/docs/4.9/columns).
:::

### Ajouter les filtres dans Tabulator

En suivant la documentation, je vous laisse ajouter **dans le pr√©c√©dent tableau** des filtres permettant la recherche.

[La documentation](http://tabulator.info/docs/4.9/filter)

### Ajouter un √©l√©ment via l'Ajax

Ce n'est pas le but de ce TP, mais si vous souhaitez ajouter un √©l√©ment via une action en Ajax il vous suffit de faire en JavaScript :

```javascript
function createNewConcert(name, date) {
  const formData = new FormData();
  formData.append("name", name);
  formData.append("date", date);

  return fetch("/api/concert", { method: "POST", body: formData }).then(
    (response) => response.json()
  );
}
```

### Suppression via l'Ajax

Ce n'est pas le but de ce TP, mais si vous souhaitez supprimer un √©l√©ment via une action en Ajax il vous suffit de faire en JavaScript :

```javascript
function deleteNewConcert(id) {
  fetch("/api/deleteConcert" + id, { method: "DELETE" })
    .then((res) => res.json())
    .then((res) => console.log(res));
}
```

Vous pouvez par exemple [l'impl√©menter en utilisant](http://tabulator.info/examples/3.1#callbacks)

## Cr√©ation de l'API utilisateur

En reprenant le la d√©marche pr√©c√©dente, je vous laisse impl√©menter la m√™me logique pour cr√©er l'API utilisateur

| M√©thode | Chemin             | Fonctionnalit√©                                                              |
| ------- | ------------------ | --------------------------------------------------------------------------- |
| GET     | `/api/client`      | Liste de l'ensemble des clients / utilisateurs                              |
| POST    | `/api/client`      | Ajout d'un nouvel utilisateur / client (en fournissant les donn√©es en POST) |
| DELETE  | `/api/client/{id}` | Suppression d'un utilisateur sp√©cifi√© en param√®tre `id`                     |

- Cr√©ation des API.
- Cr√©ation des routes.
- Cr√©ation du code permettant l'affichage des donn√©es.

::: tip N'oubliez pas !

La partie API, c'est bien ! Mais je souhaite avoir en base de donn√©es un jeu d'essai cons√©quent.

:::
